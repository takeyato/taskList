<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç„¡é™ãƒã‚¹ãƒˆç‰ˆï¼‰</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<style>
  #commentWrapper {
    border: 2px solid #ccc;
    padding: 20px;
    border-radius: 6px;
    background: #fff;
  }

  /* ãƒã‚¹ãƒˆãŒæ·±ããªã‚‹ã»ã©ç¸¦ç·šãŒå¢—ãˆã‚‹ */
  .comment-box {
    border-left: 2px solid #dee2e6;
    margin-left: 20px;
    padding-left: 15px;
  }
</style>
</head>

<body class="bg-light p-4">

<h3>ğŸ’¬ ã‚³ãƒ¡ãƒ³ãƒˆæ¬„</h3>

<div id="commentWrapper">

  <div class="mb-3">
    <textarea id="newComment" class="form-control" rows="3" placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."></textarea>
    <button id="postRoot" class="btn btn-primary mt-2">æŠ•ç¨¿</button>
  </div>

  <div id="commentList"></div>

</div>

<script>
  let comments = [];
  let toggleState = {};

  function postComment(parentId = null) {
    const text = parentId
      ? $(`#reply-${parentId}`).val()
      : $("#newComment").val();

    if (!text.trim()) return;

    const newId = Date.now();

    comments.push({ id: newId, parentId, text });

    if (!parentId) {
      $("#newComment").val("");
    } else {
      $(`#reply-${parentId}`).val("");
      toggleState[parentId] = true; // è¿”ä¿¡æ™‚ã¯å±•é–‹
    }

    renderComments();
  }

  function buildTree(list, parentId = null) {
    return list
      .filter(c => c.parentId === parentId)
      .map(c => ({ ...c, children: buildTree(list, c.id) }));
  }

  // â˜… è¶…ã‚·ãƒ³ãƒ—ãƒ«ï¼šãƒã‚¹ãƒˆã¯ç„¡é™ã€ç¸¦ç·šã‚‚ç„¡é™ã€ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚‚ç„¡é™
  function renderTree(nodes, depth = 0) {
    return nodes.map(node => {
      const isOpen = toggleState[node.id] ?? false;

      return `
        <div class="mt-3" style="margin-left:${depth * 20}px;">
          <p class="mb-1">${node.text}</p>

          <button class="btn btn-sm btn-outline-secondary" onclick="toggleReply(${node.id})">è¿”ä¿¡</button>

          <div id="replyBox-${node.id}" class="mt-2" style="display:none;">
            <textarea id="reply-${node.id}" class="form-control mb-2" rows="2"></textarea>
            <button class="btn btn-sm btn-primary" onclick="postComment(${node.id})">è¿”ä¿¡ã‚’æŠ•ç¨¿</button>
          </div>

          ${
            node.children.length > 0
              ? `
                <button class="btn btn-link p-0 mt-1" onclick="toggleChildren(${node.id})">
                  <span id="toggleText-${node.id}">
                    ${isOpen ? "é–‰ã˜ã‚‹" : node.children.length + "ä»¶ã®è¿”ä¿¡"}
                  </span>
                </button>
              `
              : ""
          }

          <div id="children-${node.id}" class="comment-box" style="display:${isOpen ? "block" : "none"};">
            ${renderTree(node.children, depth + 1)}
          </div>
        </div>
      `;
    }).join("");
  }

  function renderComments() {
    const tree = buildTree(comments);
    $("#commentList").html(renderTree(tree));
  }

  function toggleReply(id) {
    $(`#replyBox-${id}`).toggle();
  }

  function toggleChildren(id) {
    toggleState[id] = !toggleState[id];
    renderComments();
  }

  $("#postRoot").on("click", () => postComment());
</script>

</body>
</html>
